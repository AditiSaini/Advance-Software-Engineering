$(document).ready(function() {
    console.log("running");
    run();
});

async function run() {
    // load the models
    await faceapi.nets.ssdMobilenetv1.loadFromUri("/models");

    await faceapi.loadFaceLandmarkModel("/models");
    await faceapi.loadFaceRecognitionModel("/models");

    // try to access users webcam and stream the images
    // to the video element
    const videoEl = document.getElementById("inputVideo");
    navigator.getUserMedia(
        { video: {} },
        stream => (videoEl.srcObject = stream),
        err => console.error(err)
    );
}

async function onPlay(param) {
    var labelData = `[{"label":"naseer","descriptors":[[-0.09558935463428497,0.08613231033086777,0.04587109386920929,-0.06560465693473816,0.03852657601237297,-0.06749507039785385,0.00961195770651102,-0.06165851652622223,0.17557315528392792,-0.0767064094543457,0.21142923831939697,-0.023840026929974556,-0.19688080251216888,-0.14337460696697235,-0.011098395101726055,0.16600222885608673,-0.17638081312179565,-0.12439437210559845,-0.14226770401000977,-0.15272068977355957,-0.01606239192187786,0.034311141818761826,0.0740511491894722,0.004267172422260046,-0.08249872177839279,-0.36002400517463684,-0.09313960373401642,-0.14387771487236023,0.03895100951194763,-0.08830387145280838,-0.02124309353530407,-0.058471184223890305,-0.2851542830467224,-0.08033119887113571,-0.045998092740774155,0.020754050463438034,0.000745154160540551,-0.08612164855003357,0.1684122234582901,0.020418288186192513,-0.08038271963596344,-0.08450748026371002,0.02597949281334877,0.23073139786720276,0.18496285378932953,0.02556249499320984,-0.04945753514766693,0.07249061018228531,0.04916052520275116,-0.2675617039203644,0.07645336538553238,0.05667703226208687,0.12936806678771973,0.056969400495290756,0.06493929028511047,-0.08746615052223206,0.025326533243060112,0.07130416482686996,-0.21473053097724915,-0.01321866363286972,-0.00025256158551201224,-0.08130037039518356,-0.07989293336868286,0.003172580385580659,0.26475247740745544,0.1416514664888382,-0.10529332607984543,-0.06323675811290741,0.11207078397274017,-0.13936445116996765,0.08538027107715607,-0.032799530774354935,-0.07097873091697693,-0.13056275248527527,-0.32483088970184326,0.10571590065956116,0.3517190217971802,0.1358080804347992,-0.12982076406478882,0.01271775458008051,-0.12094543874263763,0.016303952783346176,0.03915823623538017,-0.04229128733277321,-0.13693861663341522,0.07401055097579956,-0.1188555434346199,0.08021713048219681,0.10133583098649979,-0.023744922131299973,-0.0937945619225502,0.1764834076166153,-0.12967243790626526,0.02670796774327755,0.01425753440707922,-0.0014312638668343425,-0.069087915122509,-0.028618911281228065,-0.06051011383533478,0.07425855845212936,0.09263876080513,-0.06973668932914734,-0.016565091907978058,0.08046884834766388,-0.11591830849647522,0.017038069665431976,-0.01027902215719223,-0.07156579941511154,-0.023388583213090897,0.03217286244034767,-0.1550915390253067,-0.12062511593103409,0.10493981838226318,-0.19395337998867035,0.1875842660665512,0.18867610394954681,-0.08554869890213013,0.1840715855360031,0.04134436696767807,0.0589950755238533,-0.04810292273759842,-0.0017351321876049042,-0.11385281383991241,-0.07153976708650589,0.07287950068712234,0.036158014088869095,0.1132933497428894,0.044718556106090546]]},{"label":"abhinav","descriptors":[[-0.07235787063837051,0.049575984477996826,0.03013199009001255,-0.0022436112631112337,-0.047397978603839874,-0.009994059801101685,-0.08674316853284836,-0.07541971653699875,0.15742841362953186,-0.03803621605038643,0.17482563853263855,-0.0615990087389946,-0.20956732332706451,0.00011800298671005294,-0.09936313331127167,0.049992870539426804,-0.1266462802886963,-0.015080109238624573,-0.016289448365569115,-0.07357900589704514,0.04354631528258324,0.10842905938625336,0.05549401789903641,0.0642673522233963,-0.13667115569114685,-0.32333171367645264,-0.12394016236066818,-0.14482611417770386,-0.03144649416208267,-0.08893042802810669,0.015188794583082199,0.015820153057575226,-0.13629654049873352,-0.010041716508567333,0.03780750185251236,0.08415992558002472,-0.0668269470334053,0.005881090648472309,0.1966341733932495,0.03826776519417763,-0.07791650295257568,-0.043154455721378326,0.016614263877272606,0.2757793664932251,0.1855524629354477,0.13415606319904327,-0.043612733483314514,-0.04268120229244232,0.0729968249797821,-0.2739753723144531,0.1439075469970703,0.14535899460315704,0.08278536796569824,0.07460194081068039,0.10712958127260208,-0.13959620893001556,-0.029738597571849823,0.08393225073814392,-0.12649600207805634,0.09152057021856308,0.01933322846889496,-0.024763256311416626,0.019947491586208344,-0.010409539565443993,0.27310454845428467,0.09984104335308075,-0.16765950620174408,-0.05501140281558037,0.08648926019668579,-0.2080538123846054,-0.054225657135248184,0.058753352612257004,-0.074273481965065,-0.2044447362422943,-0.3093165159225464,0.09200605750083923,0.45729222893714905,0.15452425181865692,-0.15669164061546326,-0.00172643072437495,-0.0855935588479042,-0.01956397294998169,0.0969841331243515,0.029343603178858757,-0.10367846488952637,-0.02322499267756939,-0.06019622087478638,-0.0061011058278381824,0.17114762961864471,-0.02196413278579712,-0.11418416351079941,0.22663390636444092,-0.08222345262765884,0.10856512188911438,0.030698008835315704,0.005062321666628122,-0.06150751933455467,-0.018927330151200294,-0.07136616110801697,0.030789397656917572,0.05248453840613365,-0.05645572766661644,0.01905481331050396,0.10265082120895386,-0.17500780522823334,0.12162961065769196,-0.0008760949713177979,-0.06435845792293549,0.02919333428144455,0.05894785374403,-0.2669879198074341,-0.038234464824199677,0.2381017506122589,-0.3379836082458496,0.21315443515777588,0.09883718937635422,0.037483762949705124,0.20230568945407867,0.10208301246166229,0.08537404239177704,0.009314773604273796,-0.0047125741839408875,-0.1020091101527214,-0.062253985553979874,0.05738580971956253,0.00972333550453186,0.0679064467549324,0.02646028995513916]]},{"label":"gujju","descriptors":[[-0.09645355492830276,0.051679469645023346,0.010686264373362064,-0.07175581157207489,-0.00574456388130784,0.011414727196097374,-0.02367408759891987,-0.06722944229841232,0.20917126536369324,-0.07426758110523224,0.16718894243240356,-0.0485585480928421,-0.13789738714694977,-0.1129988357424736,-0.041981037706136703,0.10647310316562653,-0.20791740715503693,-0.16848258674144745,-0.07809224724769592,-0.1459788680076599,0.0038280156441032887,-0.005352675914764404,-0.027884548529982567,-0.005983677227050066,-0.1847718358039856,-0.3397248387336731,-0.08955777436494827,-0.15671482682228088,0.0014206728665158153,-0.057269297540187836,0.02070624567568302,0.06796577572822571,-0.20051468908786774,-0.09487000852823257,-0.0010161841055378318,0.10192106664180756,-0.01728246919810772,-0.044782958924770355,0.1247047409415245,0.00831992644816637,-0.05177212879061699,0.04869839921593666,0.04456936940550804,0.33808425068855286,0.1345207393169403,0.05504034832119942,-0.016004653647542,-0.04922608286142349,0.15063278377056122,-0.22557619214057922,0.099884033203125,0.16572116315364838,0.06608914583921432,0.10494638979434967,0.09042992442846298,-0.04165129363536835,0.019651301205158234,0.1014261245727539,-0.18481262028217316,0.043413110077381134,0.04102225974202156,0.07091230899095535,-0.05786527693271637,-0.1044909730553627,0.24177443981170654,0.17910584807395935,-0.12549535930156708,-0.07822806388139725,0.1283843070268631,-0.06719616055488586,-0.036086902022361755,-0.05132089555263519,-0.15219749510288239,-0.14083406329154968,-0.2543564736843109,0.12142284214496613,0.44131141901016235,0.09833858907222748,-0.13143296539783478,0.0147657236084342,-0.10921807587146759,-0.018970003351569176,0.0754406675696373,0.018597614020109177,-0.1214316263794899,0.01573576219379902,-0.013091166503727436,0.08610041439533234,0.15409281849861145,0.020835919305682182,-0.07797613739967346,0.1423274129629135,-0.03458627313375473,-0.012229026295244694,0.02473658137023449,0.020650651305913925,-0.1040830984711647,0.03055216185748577,-0.16843844950199127,-0.009993361309170723,0.08567506819963455,-0.020510859787464142,0.004229860380291939,0.11690952628850937,-0.10265769064426422,0.12352684885263443,0.06143360957503319,-0.0043204245157539845,0.0329495407640934,0.07405171543359756,-0.13115127384662628,-0.08781258016824722,0.1282394826412201,-0.21397027373313904,0.15231025218963623,0.11582937091588974,0.03065810538828373,0.15332885086536407,0.06706497818231583,0.07310604304075241,-0.026465773582458496,0.03286205977201462,-0.14441847801208496,-0.04076856002211571,0.06257131695747375,0.0944773480296135,0.010749446228146553,0.03976535424590111]]}]`;

    var input = document.getElementById("inputVideo");

    const displaySize = {
        width: input.videoWidth,
        height: input.videoHeight
    };
    // resize the overlay canvas to the input dimensions
    const canvas = document.getElementById("overlay");
    faceapi.matchDimensions(canvas, displaySize);

    const labels = ["naseer", "abhinav", "gujju"];

    const labeledFaceDescriptors = await Promise.all(
        labels.map(async label => {
            // fetch image data from urls and convert blob to HTMLImage element
            const imgUrl = `faces/${label}.jpg`;
            const img = await faceapi.fetchImage(imgUrl);

            // detect the face with the highest score in the image and compute it's landmarks and face descriptor
            const fullFaceDescription = await faceapi
                .detectSingleFace(img)
                .withFaceLandmarks()
                .withFaceDescriptor();

            if (!fullFaceDescription) {
                throw new Error(`no faces detected for ${label}`);
            }

            const faceDescriptors = [fullFaceDescription.descriptor];
            return new faceapi.LabeledFaceDescriptors(label, faceDescriptors);
        })
    );

    // var parsedLabelData = JSON.parse(labelData);

    // var labeledFaceDescriptors = faceapi.LabeledFaceDescriptors.fromJSON(
    //     parsedLabelData
    // );
    const maxDescriptorDistance = 0.6;
    const faceMatcher = new faceapi.FaceMatcher(
        labeledFaceDescriptors,
        maxDescriptorDistance
    );
    // const faceMatcher = new faceapi.FaceMatcher.fromJSON(
    //     `{"distanceThreshold":0.6,"labeledDescriptors":[{"label":"naseer","descriptors":[[-0.09558935463428497,0.08613231033086777,0.04587109386920929,-0.06560465693473816,0.03852657601237297,-0.06749507039785385,0.00961195770651102,-0.06165851652622223,0.17557315528392792,-0.0767064094543457,0.21142923831939697,-0.023840026929974556,-0.19688080251216888,-0.14337460696697235,-0.011098395101726055,0.16600222885608673,-0.17638081312179565,-0.12439437210559845,-0.14226770401000977,-0.15272068977355957,-0.01606239192187786,0.034311141818761826,0.0740511491894722,0.004267172422260046,-0.08249872177839279,-0.36002400517463684,-0.09313960373401642,-0.14387771487236023,0.03895100951194763,-0.08830387145280838,-0.02124309353530407,-0.058471184223890305,-0.2851542830467224,-0.08033119887113571,-0.045998092740774155,0.020754050463438034,0.000745154160540551,-0.08612164855003357,0.1684122234582901,0.020418288186192513,-0.08038271963596344,-0.08450748026371002,0.02597949281334877,0.23073139786720276,0.18496285378932953,0.02556249499320984,-0.04945753514766693,0.07249061018228531,0.04916052520275116,-0.2675617039203644,0.07645336538553238,0.05667703226208687,0.12936806678771973,0.056969400495290756,0.06493929028511047,-0.08746615052223206,0.025326533243060112,0.07130416482686996,-0.21473053097724915,-0.01321866363286972,-0.00025256158551201224,-0.08130037039518356,-0.07989293336868286,0.003172580385580659,0.26475247740745544,0.1416514664888382,-0.10529332607984543,-0.06323675811290741,0.11207078397274017,-0.13936445116996765,0.08538027107715607,-0.032799530774354935,-0.07097873091697693,-0.13056275248527527,-0.32483088970184326,0.10571590065956116,0.3517190217971802,0.1358080804347992,-0.12982076406478882,0.01271775458008051,-0.12094543874263763,0.016303952783346176,0.03915823623538017,-0.04229128733277321,-0.13693861663341522,0.07401055097579956,-0.1188555434346199,0.08021713048219681,0.10133583098649979,-0.023744922131299973,-0.0937945619225502,0.1764834076166153,-0.12967243790626526,0.02670796774327755,0.01425753440707922,-0.0014312638668343425,-0.069087915122509,-0.028618911281228065,-0.06051011383533478,0.07425855845212936,0.09263876080513,-0.06973668932914734,-0.016565091907978058,0.08046884834766388,-0.11591830849647522,0.017038069665431976,-0.01027902215719223,-0.07156579941511154,-0.023388583213090897,0.03217286244034767,-0.1550915390253067,-0.12062511593103409,0.10493981838226318,-0.19395337998867035,0.1875842660665512,0.18867610394954681,-0.08554869890213013,0.1840715855360031,0.04134436696767807,0.0589950755238533,-0.04810292273759842,-0.0017351321876049042,-0.11385281383991241,-0.07153976708650589,0.07287950068712234,0.036158014088869095,0.1132933497428894,0.044718556106090546]]},{"label":"abhinav","descriptors":[[-0.07235787063837051,0.049575984477996826,0.03013199009001255,-0.0022436112631112337,-0.047397978603839874,-0.009994059801101685,-0.08674316853284836,-0.07541971653699875,0.15742841362953186,-0.03803621605038643,0.17482563853263855,-0.0615990087389946,-0.20956732332706451,0.00011800298671005294,-0.09936313331127167,0.049992870539426804,-0.1266462802886963,-0.015080109238624573,-0.016289448365569115,-0.07357900589704514,0.04354631528258324,0.10842905938625336,0.05549401789903641,0.0642673522233963,-0.13667115569114685,-0.32333171367645264,-0.12394016236066818,-0.14482611417770386,-0.03144649416208267,-0.08893042802810669,0.015188794583082199,0.015820153057575226,-0.13629654049873352,-0.010041716508567333,0.03780750185251236,0.08415992558002472,-0.0668269470334053,0.005881090648472309,0.1966341733932495,0.03826776519417763,-0.07791650295257568,-0.043154455721378326,0.016614263877272606,0.2757793664932251,0.1855524629354477,0.13415606319904327,-0.043612733483314514,-0.04268120229244232,0.0729968249797821,-0.2739753723144531,0.1439075469970703,0.14535899460315704,0.08278536796569824,0.07460194081068039,0.10712958127260208,-0.13959620893001556,-0.029738597571849823,0.08393225073814392,-0.12649600207805634,0.09152057021856308,0.01933322846889496,-0.024763256311416626,0.019947491586208344,-0.010409539565443993,0.27310454845428467,0.09984104335308075,-0.16765950620174408,-0.05501140281558037,0.08648926019668579,-0.2080538123846054,-0.054225657135248184,0.058753352612257004,-0.074273481965065,-0.2044447362422943,-0.3093165159225464,0.09200605750083923,0.45729222893714905,0.15452425181865692,-0.15669164061546326,-0.00172643072437495,-0.0855935588479042,-0.01956397294998169,0.0969841331243515,0.029343603178858757,-0.10367846488952637,-0.02322499267756939,-0.06019622087478638,-0.0061011058278381824,0.17114762961864471,-0.02196413278579712,-0.11418416351079941,0.22663390636444092,-0.08222345262765884,0.10856512188911438,0.030698008835315704,0.005062321666628122,-0.06150751933455467,-0.018927330151200294,-0.07136616110801697,0.030789397656917572,0.05248453840613365,-0.05645572766661644,0.01905481331050396,0.10265082120895386,-0.17500780522823334,0.12162961065769196,-0.0008760949713177979,-0.06435845792293549,0.02919333428144455,0.05894785374403,-0.2669879198074341,-0.038234464824199677,0.2381017506122589,-0.3379836082458496,0.21315443515777588,0.09883718937635422,0.037483762949705124,0.20230568945407867,0.10208301246166229,0.08537404239177704,0.009314773604273796,-0.0047125741839408875,-0.1020091101527214,-0.062253985553979874,0.05738580971956253,0.00972333550453186,0.0679064467549324,0.02646028995513916]]},{"label":"gujju","descriptors":[[-0.09645355492830276,0.051679469645023346,0.010686264373362064,-0.07175581157207489,-0.00574456388130784,0.011414727196097374,-0.02367408759891987,-0.06722944229841232,0.20917126536369324,-0.07426758110523224,0.16718894243240356,-0.0485585480928421,-0.13789738714694977,-0.1129988357424736,-0.041981037706136703,0.10647310316562653,-0.20791740715503693,-0.16848258674144745,-0.07809224724769592,-0.1459788680076599,0.0038280156441032887,-0.005352675914764404,-0.027884548529982567,-0.005983677227050066,-0.1847718358039856,-0.3397248387336731,-0.08955777436494827,-0.15671482682228088,0.0014206728665158153,-0.057269297540187836,0.02070624567568302,0.06796577572822571,-0.20051468908786774,-0.09487000852823257,-0.0010161841055378318,0.10192106664180756,-0.01728246919810772,-0.044782958924770355,0.1247047409415245,0.00831992644816637,-0.05177212879061699,0.04869839921593666,0.04456936940550804,0.33808425068855286,0.1345207393169403,0.05504034832119942,-0.016004653647542,-0.04922608286142349,0.15063278377056122,-0.22557619214057922,0.099884033203125,0.16572116315364838,0.06608914583921432,0.10494638979434967,0.09042992442846298,-0.04165129363536835,0.019651301205158234,0.1014261245727539,-0.18481262028217316,0.043413110077381134,0.04102225974202156,0.07091230899095535,-0.05786527693271637,-0.1044909730553627,0.24177443981170654,0.17910584807395935,-0.12549535930156708,-0.07822806388139725,0.1283843070268631,-0.06719616055488586,-0.036086902022361755,-0.05132089555263519,-0.15219749510288239,-0.14083406329154968,-0.2543564736843109,0.12142284214496613,0.44131141901016235,0.09833858907222748,-0.13143296539783478,0.0147657236084342,-0.10921807587146759,-0.018970003351569176,0.0754406675696373,0.018597614020109177,-0.1214316263794899,0.01573576219379902,-0.013091166503727436,0.08610041439533234,0.15409281849861145,0.020835919305682182,-0.07797613739967346,0.1423274129629135,-0.03458627313375473,-0.012229026295244694,0.02473658137023449,0.020650651305913925,-0.1040830984711647,0.03055216185748577,-0.16843844950199127,-0.009993361309170723,0.08567506819963455,-0.020510859787464142,0.004229860380291939,0.11690952628850937,-0.10265769064426422,0.12352684885263443,0.06143360957503319,-0.0043204245157539845,0.0329495407640934,0.07405171543359756,-0.13115127384662628,-0.08781258016824722,0.1282394826412201,-0.21397027373313904,0.15231025218963623,0.11582937091588974,0.03065810538828373,0.15332885086536407,0.06706497818231583,0.07310604304075241,-0.026465773582458496,0.03286205977201462,-0.14441847801208496,-0.04076856002211571,0.06257131695747375,0.0944773480296135,0.010749446228146553,0.03976535424590111]]}]}`
    // );

    var saveData = JSON.stringify(faceMatcher.toJSON());
    console.log(saveData);
    // var blob = new Blob([saveData], { type: "text/plain;charset=utf-8" });
    // saveAs(blob, "face-matcher.json");

    // var saveInfo = labeledFaceDescriptors
    // console.log(saveInfo);
    // console.log("works till her");
    // const mtcnnResults = await faceapi.mtcnn(input, mtcnnForwardParams);
    // console.log("did it work");
    // console.log(mtcnnResults);
    var print = true;
    setInterval(async () => {
        // const detections = await faceapi.detectAllFaces(input);
        const fullFaceDescriptions = await faceapi
            .detectAllFaces(input)
            .withFaceLandmarks()
            .withFaceDescriptors();

        // if (print) {
        //     console.log(fullFaceDescriptions);
        //     print = false;
        // }

        // const resizedDetections = faceapi.resizeResults(
        //     detections,
        //     displaySize
        // );
        // // draw detections into the canvas
        // faceapi.draw.drawDetections(canvas, resizedDetections);

        const results = fullFaceDescriptions.map(fd =>
            faceMatcher.findBestMatch(fd.descriptor)
        );

        console.log(results);

        const context = canvas.getContext("2d");

        context.clearRect(0, 0, canvas.width, canvas.height);
        results.forEach((bestMatch, i) => {
            const box = fullFaceDescriptions[i].detection.box;
            const text = bestMatch.toString();
            const drawBox = new faceapi.draw.DrawBox(box, { label: text });
            drawBox.draw(canvas);
        });
    }, 500);

    // const displaySize = { width: input.width, height: input.height };
    // // resize the overlay canvas to the input dimensions
    // const canvas = document.getElementById("overlay");
    // // faceapi.matchDimensions(canvas, displaySize);

    // // const resizedDetections = faceapi.resizeResults(mtcnnResults, displaySize);
    // // draw detections into the canvas
    // faceapi.draw.drawDetections(canvas, mtcnnResults);

    // faceapi.drawDetection(
    //     "overlay",
    //     mtcnnResults.map(res => res.faceDetection),
    //     { withScore: false }
    // );
}
